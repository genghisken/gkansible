---
# MAIN TASKS TO BE EXECUTED BY install-anaconda ROLE

#- name: install Open JDK Debian
#  apt:
#    name: openjdk-8-jdk
#    state: present
#  become: true
#  when: ansible_os_family == "Debian"

#- name: install Open JDK CentOS
#  apt:
#    name: java-1.8.0-openjdk
#    state: present
#  become: true
#  when: ansible_os_family == "RedHat"

#- name: install HTTPS transport (not sure why yet)
#  apt:
#    name: apt-transport-https
#    state: present
#  become: true
#  when: ansible_os_family == "Debian"

#- name: install Cassandra
#  apt:
#    name: cassandra
#    state: present
#  become: true

# The following tasks now need to be done.
# 1. Shut down cassandra
# 2. Remove the cassandra datafiles: sudo rm -rf /var/lib/cassandra/*
# 3. Get list of IP addresses from the hosts.yaml file.
# 4. Get list of Seed servers (usually 2 or 3 out of N, where N >= 5.)
# 5. Copy the template Cassandra file in place (/etc/cassandra/) and EDIT in place:
#    - set broadcast_rpc_address to IP address of the target server (ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}')
#    - set the server list to the list of addresses in the hosts.yaml file
#    - set the seed list to 2 or 3 of the list of addresses in the hosts.yaml file.
# 6. Copy the template rackdc properties file (cassandra-rackdc.properties) in place to /etc/cassandra (no changes necessary)
# 7. Remove the topology properties file. sudo rm -f /etc/cassandra/cassandra-topology.properties
# 8. Copy the (modified) cassandra.yaml file in place to /etc/cassandra
# DO NOT START THE SERVICE. This should be done manually (seeds first, then other nodes).

- name: main configuration (cassandra.yaml)
  template:
    src: cassandra.yaml.j2
    dest: '{{ cassandra_config_dir }}/conf/cassandra.yaml'
    #mode: 0644
    #owner: atls
    #group: atls
    #backup: true

- name: main configuration (cassandra-rackdc.properties)
  template:
    src: cassandra-rackdc.properties.j2
    dest: '{{ cassandra_config_dir }}/conf/cassandra-rackdc.properties'
    #mode: 0644
    #owner: atls
    #group: atls
    #backup: true

- name: main configuration (cassandra.repo)
  template:
    src: cassandra.yum.repo.j2
    dest: '/tmp/cassandra.repo'
    #mode: 0644
    #owner: root
    #group: root
  when: ansible_os_family == "RedHat"

#- name: get cassandra repo
#  shell: 'wget -q -O - {{ cassandra_server }}/KEYS | sudo apt-key add -'
#  become: true
#  when: ansible_os_family == "Debian"

#- name: add cassandra
#  shell: 'echo "deb {{ cassandra_server }}/debian 311x main" > /etc/apt/sources.list.d/cassandra.list'
#  become: true
#  when: ansible_os_family == "Debian"

#- name: "Update packages"
#  become: true
#  apt:
#    update_cache: yes # apt-get update
#  when: ansible_os_family == "Debian"

